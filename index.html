import React, { useState } from 'react';
import { Download, Zap, Wind, FileArchive } from 'lucide-react';

const SRB2CharacterGenerator = () => {
  const [charName, setCharName] = useState('Orange Sonic');
  const [downloading, setDownloading] = useState(false);

  const generateSOCFile = () => {
    return `# Orange Sonic - Dragon Ball Character Mod
# Custom character with Kamehameha, Spirit Bomb, and Flight abilities

Character ${charName.replace(/\s+/g, '')}
{
  Name = ${charName}
  Skincolor = SKIN_ORANGE
  Prefcolor = Orange
  Speed = 36
  Accel = 45
  Thrustfactor = 5
  Jumpfactor = 1.0
  Ability = CA_FLY
  Ability2 = CA_DOUBLEJUMP
  Normalspeed = 36
  Runspeed = 28
  Flags = SF_NOSKID|SF_RUNONWATER
  
  # Custom Dragon Ball Abilities
  # Press Custom 1 for Kamehameha
  # Press Custom 2 for Spirit Bomb
  # Press Jump twice to activate flight
}

# Kamehameha Attack State
State S_PLAY_KAMEHAMEHA
{
  SpriteFrame = A
  Duration = 35
  Next = S_PLAY_STND
  Action = A_FireShot
  Var1 = MT_THOK
  Var2 = 1
}

# Spirit Bomb State
State S_PLAY_SPIRITBOMB
{
  SpriteFrame = A
  Duration = 70
  Next = S_PLAY_STND
  Action = A_BossScream
  Var1 = MT_EGGMOBILE_FIRE
  Var2 = PC_HURT
}

# Flight ability - Enhanced duration
Object MT_TAILSOVERLAY_ORANGE
{
  Radius = 393216
  Height = 786432
  Flags = MF_NOBLOCKMAP|MF_NOCLIP|MF_NOCLIPHEIGHT|MF_NOGRAVITY
  SpawnState = S_TAILSOVERLAY_STAND
}

# Energy projectile for Kamehameha
Thing MT_KAMEHAMEHA_BLAST
{
  Radius = 16
  Height = 32
  Speed = 40
  Damage = 5
  RenderFlags = RF_FULLBRIGHT
  Flags = MF_NOGRAVITY|MF_MISSILE
  SpawnState = S_THOK
  DeathState = S_SPRK1
}

# Lua script hooks for custom abilities
LUAFILE "Lua/OrangeSonic.lua"`;
  };

  const generateLuaFile = () => {
    return `-- Orange Sonic Dragon Ball Abilities
-- Kamehameha, Spirit Bomb, and Flight mechanics

local kamehameha_cooldown = {}
local spiritbomb_cooldown = {}
local flight_power = {}

-- Initialize player data
addHook("PlayerSpawn", function(player)
    if player.mo and player.mo.skin == "orangesonic" then
        kamehameha_cooldown[player] = 0
        spiritbomb_cooldown[player] = 0
        flight_power[player] = 100
    end
end)

-- Kamehameha Attack (Custom Button 1)
addHook("PlayerThink", function(player)
    if not (player.mo and player.mo.skin == "orangesonic") then return end
    
    -- Decrease cooldowns
    if kamehameha_cooldown[player] > 0 then
        kamehameha_cooldown[player] = $ - 1
    end
    if spiritbomb_cooldown[player] > 0 then
        spiritbomb_cooldown[player] = $ - 1
    end
    
    -- Kamehameha (Custom 1)
    if player.cmd.buttons & BT_CUSTOM1 and kamehameha_cooldown[player] == 0 then
        local mo = P_SpawnMobj(player.mo.x, player.mo.y, player.mo.z + 32*FRACUNIT, MT_THOK)
        mo.angle = player.mo.angle
        P_InstaThrust(mo, mo.angle, 40*FRACUNIT)
        mo.momz = 0
        mo.flags = $|MF_MISSILE
        mo.color = SKINCOLOR_ORANGE
        
        S_StartSound(player.mo, sfx_s3k5d) -- Energy sound
        kamehameha_cooldown[player] = 35 -- 1 second cooldown
        
        P_SpawnMobj(player.mo.x, player.mo.y, player.mo.z, MT_THOK).color = SKINCOLOR_YELLOW
    end
    
    -- Spirit Bomb (Custom 2 - Hold for charge)
    if player.cmd.buttons & BT_CUSTOM2 and spiritbomb_cooldown[player] == 0 then
        -- Charge effect
        if leveltime % 4 == 0 then
            local sparkle = P_SpawnMobj(
                player.mo.x + P_RandomRange(-64, 64)*FRACUNIT,
                player.mo.y + P_RandomRange(-64, 64)*FRACUNIT,
                player.mo.z + P_RandomRange(0, 96)*FRACUNIT,
                MT_SPARK
            )
            sparkle.color = SKINCOLOR_CYAN
        end
        
        player.mo.momx = 0
        player.mo.momy = 0
    elseif player.pflags & PF_JUMPED and spiritbomb_cooldown[player] == 0 
           and player.cmd.buttons & BT_CUSTOM2 == 0 then
        -- Release spirit bomb
        local bomb = P_SpawnMobj(player.mo.x, player.mo.y, player.mo.z + 64*FRACUNIT, MT_EGGMOBILE_FIRE)
        bomb.angle = player.mo.angle
        P_InstaThrust(bomb, bomb.angle, 25*FRACUNIT)
        bomb.momz = -8*FRACUNIT
        bomb.scale = 2*FRACUNIT
        bomb.color = SKINCOLOR_AQUA
        
        S_StartSound(player.mo, sfx_s3kb4) -- Explosion sound
        spiritbomb_cooldown[player] = 105 -- 3 second cooldown
    end
    
    -- Enhanced flight ability
    if player.pflags & PF_THOKKED then
        if flight_power[player] > 0 then
            player.mo.momz = 8*FRACUNIT -- Upward thrust
            flight_power[player] = $ - 1
            
            -- Flight particles
            if leveltime % 3 == 0 then
                local trail = P_SpawnMobj(player.mo.x, player.mo.y, player.mo.z, MT_THOK)
                trail.color = SKINCOLOR_ORANGE
                trail.scale = FRACUNIT/2
            end
        end
    else
        -- Regenerate flight power on ground
        if player.mo.eflags & MFE_TOUCHWATER or P_IsObjectOnGround(player.mo) then
            if flight_power[player] < 100 then
                flight_power[player] = $ + 2
            end
        end
    end
end)

-- HUD Display
hud.add(function(v, player)
    if not (player.mo and player.mo.skin == "orangesonic") then return end
    
    local y = 180
    
    -- Kamehameha cooldown
    if kamehameha_cooldown[player] > 0 then
        v.drawString(4, y, "Kamehameha: "..kamehameha_cooldown[player]/TICRATE.."s", V_SNAPTOLEFT|V_SNAPTOBOTTOM, "thin")
        y = $ + 8
    else
        v.drawString(4, y, "Kamehameha: READY", V_SNAPTOLEFT|V_SNAPTOBOTTOM|V_YELLOWMAP, "thin")
        y = $ + 8
    end
    
    -- Spirit Bomb cooldown
    if spiritbomb_cooldown[player] > 0 then
        v.drawString(4, y, "Spirit Bomb: "..spiritbomb_cooldown[player]/TICRATE.."s", V_SNAPTOLEFT|V_SNAPTOBOTTOM, "thin")
        y = $ + 8
    else
        v.drawString(4, y, "Spirit Bomb: READY", V_SNAPTOLEFT|V_SNAPTOBOTTOM|V_CYANMAP, "thin")
        y = $ + 8
    end
    
    -- Flight power
    local color = V_GREENMAP
    if flight_power[player] < 30 then color = V_REDMAP
    elseif flight_power[player] < 60 then color = V_YELLOWMAP end
    
    v.drawString(4, y, "Flight: "..flight_power[player].."%", V_SNAPTOLEFT|V_SNAPTOBOTTOM|color, "thin")
end, "game")`;
  };

  const generateS_SKIN = () => {
    return `# S_SKIN for Orange Sonic
name = orangesonic
realname = ${charName}
sprite = PLAY
superspr = PLAY

# Character properties
ability = CA_FLY
ability2 = CA_DOUBLEJUMP
accel = 45
thrustfactor = 5
normalspeed = 36
runspeed = 28
jumpfactor = 1.0

# Colors
prefcolor = Orange
supercolor = Supergold1

# Flags
flags = SF_NOSKID|SF_RUNONWATER

# Sounds
soundsid = 0

# HUD
hudname = ORANGE
hudnamecol = \\x85

# Description
description = An orange-colored Sonic with Dragon Ball Z powers! Use Custom 1 for Kamehameha, Custom 2 for Spirit Bomb, and jump twice to fly!`;
  };

  const generatePK3 = async () => {
    setDownloading(true);
    
    try {
      // Import JSZip from CDN
      const JSZip = (await import('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js')).default;
      
      const zip = new JSZip();
      
      // Add SOC folder and file
      const socFolder = zip.folder("SOC");
      socFolder.file("OrangeSonic.soc", generateSOCFile());
      
      // Add Lua folder and file
      const luaFolder = zip.folder("Lua");
      luaFolder.file("OrangeSonic.lua", generateLuaFile());
      
      // Add S_SKIN file in Sprites folder
      const spritesFolder = zip.folder("Sprites");
      spritesFolder.file("S_SKIN.txt", generateS_SKIN());
      
      // Add a README
      const readmeContent = `# ${charName} - Dragon Ball Character for SRB2

## Installation:
1. Place this PK3 file in your SRB2 "mods" folder
2. Load the mod in-game via the Addons menu

## Controls:
- Custom Button 1: Kamehameha (energy blast)
- Custom Button 2: Spirit Bomb (hold to charge)
- Jump twice: Activate flight mode

## Features:
- Orange-colored Sonic character
- Kamehameha energy blast (1s cooldown)
- Spirit Bomb charge attack (3s cooldown)
- Flight ability with energy meter
- Visual effects and HUD display

## Notes:
- Character skin name: "orangesonic"
- Flight energy recharges on ground/water
- All abilities have visual particle effects

## Files Included:
- SOC/OrangeSonic.soc (character definition)
- Lua/OrangeSonic.lua (ability scripts)
- Sprites/S_SKIN.txt (character skin info)

Note: This mod uses default Sonic sprites with orange coloring.
For custom sprites, you would need to create sprite files.

Created with SRB2 Dragon Ball Character Generator
`;
      
      zip.file("README.txt", readmeContent);
      
      // Generate the PK3 file
      const blob = await zip.generateAsync({ type: "blob" });
      
      // Download the file
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${charName.replace(/\s+/g, '')}.pk3`;
      a.click();
      URL.revokeObjectURL(url);
      
    } catch (error) {
      console.error('Error generating PK3:', error);
      alert('Error generating PK3 file. Please try again.');
    }
    
    setTimeout(() => setDownloading(false), 1000);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-500 via-red-500 to-yellow-500 p-4">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-lg shadow-2xl p-6">
          <div className="flex items-center justify-center mb-2">
            <FileArchive className="w-10 h-10 text-orange-600 mr-2" />
            <h1 className="text-3xl font-bold text-center text-orange-600">
              SRB2 PK3 Generator
            </h1>
          </div>
          <p className="text-center text-gray-600 mb-6 text-sm">
            Generate a complete PK3 mod with Dragon Ball powers!
          </p>

          <div className="mb-6">
            <label className="block text-sm font-bold text-gray-700 mb-2">
              Character Name
            </label>
            <input
              type="text"
              value={charName}
              onChange={(e) => setCharName(e.target.value)}
              className="w-full px-4 py-2 border-2 border-orange-300 rounded-lg focus:outline-none focus:border-orange-500"
              placeholder="Orange Sonic"
            />
          </div>

          <div className="grid grid-cols-3 gap-3 mb-6">
            <div className="bg-gradient-to-br from-yellow-100 to-orange-100 p-4 rounded-lg border-2 border-orange-300">
              <Zap className="w-8 h-8 text-yellow-600 mb-2 mx-auto" />
              <h3 className="font-bold text-center text-sm mb-1">Kamehameha</h3>
              <p className="text-xs text-gray-700 text-center">
                Energy blast
              </p>
            </div>

            <div className="bg-gradient-to-br from-blue-100 to-cyan-100 p-4 rounded-lg border-2 border-cyan-300">
              <div className="w-8 h-8 bg-cyan-500 rounded-full mb-2 mx-auto flex items-center justify-center text-white font-bold text-lg">
                üí´
              </div>
              <h3 className="font-bold text-center text-sm mb-1">Spirit Bomb</h3>
              <p className="text-xs text-gray-700 text-center">
                Charge attack
              </p>
            </div>

            <div className="bg-gradient-to-br from-orange-100 to-red-100 p-4 rounded-lg border-2 border-orange-300">
              <Wind className="w-8 h-8 text-orange-600 mb-2 mx-auto" />
              <h3 className="font-bold text-center text-sm mb-1">Flight</h3>
              <p className="text-xs text-gray-700 text-center">
                Jump twice
              </p>
            </div>
          </div>

          <div className="bg-gray-100 rounded-lg p-4 mb-6">
            <h3 className="font-bold text-base mb-2">PK3 Package Includes:</h3>
            <ul className="space-y-1 text-sm text-gray-700">
              <li>‚úì SOC/OrangeSonic.soc - Character definition</li>
              <li>‚úì Lua/OrangeSonic.lua - Ability scripts</li>
              <li>‚úì Sprites/S_SKIN.txt - Skin configuration</li>
              <li>‚úì README.txt - Installation instructions</li>
              <li>‚úì All files properly organized in PK3 format</li>
            </ul>
          </div>

          <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
            <h3 className="font-bold text-base mb-2">Character Features:</h3>
            <ul className="space-y-1 text-sm text-gray-700">
              <li>üü† Orange-colored Sonic character</li>
              <li>‚ö° Custom Button 1: Kamehameha attack</li>
              <li>üí´ Custom Button 2: Spirit Bomb (hold to charge)</li>
              <li>üå™Ô∏è Flight ability with energy meter</li>
              <li>‚ú® Visual effects for all abilities</li>
              <li>üìä On-screen HUD display</li>
            </ul>
          </div>

          <button
            onClick={generatePK3}
            disabled={downloading}
            className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-6 rounded-lg hover:from-orange-600 hover:to-red-600 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <Download className="w-5 h-5" />
            {downloading ? 'Generating PK3...' : 'Download Complete PK3 File'}
          </button>

          <div className="mt-4 bg-green-50 border-2 border-green-300 rounded-lg p-3">
            <p className="text-xs text-gray-700">
              <strong>‚úÖ Ready to use!</strong> This generates a complete PK3 file with all SOC, Lua, and sprite configuration files properly packaged. Just drop it in your SRB2 mods folder and load it!
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SRB2CharacterGenerator;
